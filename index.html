<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>SoundGuessr</title>
<style>
body {
    font-family: 'Poppins', sans-serif;
    margin:0; padding:0;
    background:#121212;
    display:flex; justify-content:center; align-items:center;
    min-height:100vh; color:#eee;
}
#container {
    background:#1e1e1e;
    width:95%; max-width:480px;
    border-radius:20px; padding:30px;
    text-align:center; box-shadow:0 7px 20px rgba(0,0,0,0.55);
}
h1 { font-size:36px; margin-bottom:24px; color:#ff6b6b; transform: rotate(-0.3deg);}
button { padding:14px 28px; margin:10px; font-size:18px; font-weight:600; border-radius:12px; border:none; cursor:pointer;}
#startBtn { background: linear-gradient(48deg,#ff6b6b,#ff9b6b); color:#fff; font-size:24px; width:80%; }
#startBtn:disabled { opacity:0.5; }
#playBtn { background: linear-gradient(42deg,#6bffb0,#00c2ff); color:#000; font-size:20px;}
#playBtn:disabled { opacity:0.5; }
#guessBox input { width:88%; padding:12px; font-size:18px; border-radius:11px; border:2px solid #555; margin-top:15px; background:#2a2a2a; color:#eee;}
#guessBox button { background: linear-gradient(46deg,#ff6b6b,#ff9b6b); color:#fff; font-size:18px; margin-top:10px; }
#roundTimer { display:flex; justify-content:space-between; font-size:22px; margin-bottom:10px; }
#progressContainer { width:100%; height:12px; background:#333; border-radius:8px; margin-bottom:14px; }
#progressBar { height:100%; width:0%; background: linear-gradient(90deg,#4ec3ff,#ff6b6b); border-radius:8px; transition: width 0.48s ease; }
#result { font-size:22px; margin-top:20px; min-height:28px; }
#backBtn { background: linear-gradient(44deg,#ffa500,#ff6b6b); color:#fff; font-size:20px; padding:14px 26px; border-radius:14px; margin-top:15px; display:none; }
</style>
</head>
<body>
<div id="container">
<h1>üéß SoundGuessr</h1>
<button id="startBtn" disabled>≈Åadowanie...</button>

<div id="gameArea" style="display:none;">
<div id="progressContainer"><div id="progressBar"></div></div>
<div id="roundTimer">
    <div id="roundInfo">Runda 1 z 8</div>
    <div id="timer">30s</div>
</div>

<button id="playBtn" disabled>Odtwarzanie</button>
<div id="info">Ka≈ºde dodatkowe odtworzenie: <b>-50 pkt</b></div>

<div id="guessBox">
<h2>Co to za d≈∫wiƒôk?</h2>
<input id="answerInput" placeholder="np. Upadek Telefonu" onkeydown="if(event.key==='Enter') checkAnswer()">
<button onclick="checkAnswer()">Zatwierd≈∫</button>
</div>

<div id="result"></div>
<button id="backBtn" onclick="location.reload()">Powr√≥t do menu g≈Ç√≥wnego</button>
</div>
</div>

<script>
const API_SOUNDS="https://api.github.com/repos/SoundGuessr/soundguessr.github.io/contents/sounds";
let aliases={};

let sounds=[], pool=[], current=null, audio=null;
let round=1, score=0, maxPoints=1000, timeLeft=30, timer;

let startBtn=document.getElementById("startBtn");
let playBtn=document.getElementById("playBtn");
let progressBar=document.getElementById("progressBar");
let timerEl=document.getElementById("timer");

let frames=["≈Åadowanie.","≈Åadowanie..","≈Åadowanie..."];
let fi=0;
let loadingInterval=setInterval(()=>{startBtn.innerText=frames[fi]; fi=(fi+1)%frames.length;},350);

// NORMALIZE & FUZZY FUNCTIONS
function normalize(t){return t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9 ]/g,"").trim();}
function levenshtein(a,b){const m=[];for(let i=0;i<=b.length;i++) m[i]=[i];for(let j=0;j<=a.length;j++) m[0][j]=j;for(let i=1;i<=b.length;i++){for(let j=1;j<=a.length;j++){m[i][j]=b[i-1]===a[j-1]?m[i-1][j-1]:Math.min(m[i-1][j-1]+1,m[i][j-1]+1,m[i-1][j]+1);}} return m[b.length][a.length];}
function fuzzyMatch(a,b){a=normalize(a); b=normalize(b); if(a===b) return true; const dist=levenshtein(a,b); return (1-dist/Math.max(a.length,b.length))>=0.8;}

// LOAD ALIASES
fetch("aliases.json").then(r=>r.json()).then(a=>aliases=a);

// LOAD SOUNDS
fetch(API_SOUNDS)
.then(res=>res.json())
.then(data=>{
    sounds=data.filter(x=>x.name.toLowerCase().endsWith(".m4a")).map(x=>({file:x.name,url:x.download_url}));
    clearInterval(loadingInterval); startBtn.innerText="Graj"; startBtn.disabled=false;
})
.catch(()=>{clearInterval(loadingInterval); startBtn.innerText="B≈ÇƒÖd!";});

startBtn.onclick=()=>{startBtn.style.display="none"; document.getElementById("gameArea").style.display="block"; startGame();};

function startGame(){pool=[...sounds]; round=1; score=0; nextRound();}
function updateProgress(){progressBar.style.width=((round-1)/8*100)+"%";}

function nextRound(){
    document.getElementById("backBtn").style.display="none";
    if(audio) audio.pause();
    if(round>8){
        progressBar.style.width="100%";
        document.getElementById("result").innerHTML="<b>Tw√≥j wynik: "+score+" pkt</b>";
        playBtn.style.display="none"; document.getElementById("guessBox").style.display="none"; document.getElementById("backBtn").style.display="inline-block"; document.getElementById("roundInfo").innerText=""; timerEl.innerText=""; return;
    }
    updateProgress();
    const idx=Math.floor(Math.random()*pool.length);
    current=pool.splice(idx,1)[0];
    document.getElementById("roundInfo").innerText=`Runda ${round} z 8`;
    timerEl.innerText="30s"; document.getElementById("answerInput").value=""; document.getElementById("result").innerText="";
    playBtn.innerText="Odtwarzanie"; playBtn.disabled=true;
    audio=new Audio(current.url);
    audio.onended=()=>{playBtn.innerText="Odtw√≥rz ponownie"; playBtn.disabled=false;};
    audio.play();
    startTimer();
}

function startTimer(){clearInterval(timer); timeLeft=30; timer=setInterval(()=>{timerEl.innerText=timeLeft+"s"; timeLeft--; if(timeLeft<0){clearInterval(timer); handleAnswer(false);}},1000);}

function playSound(){audio.play(); maxPoints-=50; playBtn.disabled=true; playBtn.innerText="ZABLOKOWANY (Odtwarzanie)"; audio.onended=()=>{playBtn.innerText="Odtw√≥rz ponownie"; playBtn.disabled=false;}}

// Clean filename ‚Üí canonical name
function formatName(f){let name=f.replace(".m4a","").replace(/\d+$/,"").replace(/[-_]/g," "); return name.split(" ").map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(" ");}

// CHECK ANSWER WITH FUZZY MATCHING
function checkAnswer(){
    let typed=normalize(document.getElementById("answerInput").value);
    if(!typed) return;
    const base=normalize(formatName(current.file));
    let ok=false;
    if(aliases[base]){
        for(const alt of aliases[base]){ if(fuzzyMatch(typed,alt)){ok=true; break; } }
    }
    handleAnswer(ok);
}

function handleAnswer(ok){
    clearInterval(timer);
    if(ok){ score+=maxPoints; document.getElementById("result").innerHTML=`<span style="color:#2ecc71;">‚úî Dobrze! +${maxPoints} pkt</span>`;}
    else{ document.getElementById("result").innerHTML=`<span style="color:#e74c3c;">‚úò ≈πle! To by≈Ço: ${formatName(current.file)}</span>`;}
    maxPoints=1000; round++; setTimeout(nextRound,1500);
}
</script>
</body>
</html>
